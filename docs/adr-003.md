# ADR-003: Метод комунікації між основним сервісом та мікросервісом mailer-service

**Статус:** Прийнято  
**Дата:** 2025-07-07  
**Автор:** Yurii Yakymiv  

## Контекст
Планується виділити функціонал відправлення електронних листів у окремий мікросервіс `mailer-service`. Потрібно обрати спосіб комунікації між основним застосунком (API) та сервісом розсилки, зважаючи на:
- Небажання блокувати HTTP-запит користувача через очікування відправки листа
- Важливість гарантованої доставки або повторної спроби
- Можливе зростання обʼєму листів у майбутньому
- Простоту масштабування та ізоляцію збоїв

## Розглянуті варіанти

### 1. Синхронний HTTP/REST запит
- **Переваги:** надзвичайно простий, не потребує додаткової інфраструктури, зрозумілий для розробників.
- **Недоліки:** основний сервіс блокується до завершення відправки, підвищена затримка для користувача, відсутність автоматичних повторів, тісне звʼязування сервісів, чутливість до збоїв мережі.

### 2. gRPC виклик
- **Переваги:** контракт-орієнтована взаємодія, швидший та компактніший протокол, можливість потокового обміну.
- **Недоліки:** усе ще синхронна модель запит-відповідь, необхідний додатковий шар генерації клієнтів/серверів, залежність від доступності сервісу розсилки при кожному запиті.

### 3. Асинхронна передача повідомлень через брокер
- **Переваги:** повне розʼєднання сервісів, відсутність блокування HTTP-запиту, автоматичні повтори та dead-letter queue, можливість горизонтального масштабування воркерів, стійкість до збоїв.
- **Недоліки:** додаткова інфраструктура (брокер), необхідність моніторингу черг.

## Прийняте рішення
Використовувати асинхронну модель з чергою повідомлень. Основний сервіс публікує подію `SendMail` у брокер RabbitMQ. Мікросервіс розсилки отримує подію, відправляє лист та, за потреби, публікує події `MailSent` або `MailFailed`.

## Наслідки

### Позитивні
- HTTP-відповідь користувачу не залежить від швидкості SMTP чи стороннього API
- Відправка листів автоматично повторюється у разі тимчасових збоїв
- Легка масштабованість кількості воркерів
- Можливість додати інші споживачі (логування, аналітика) без змін основного коду

### Негативні
- Потрібен RabbitMQ та налаштування стійкості
- Зʼявляється технічна складність у вигляді управління чергами та моніторингу
- Потрібно врахувати ідемпотентність при повторній доставці повідомлень